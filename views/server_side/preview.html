<div class="ui modal  fullscreen" id="previewModal">
  <div class="header">Select signaturies places</div>
  <div class=" scrolling  content" id="previewModalContent">

    <div class="ui celled internally grid  stackable">
      <div class="four column row orange fileTopInfosContainer">
        <div class="column four wide ">File name : <span id="fileNameText"></span></div>
        <div class="column four wide">Signaturies number :<span id="signsNumberText"></span></div>
        <div class="column four wide">File type : <span id="fileTypeText"></span></div>
        <div class="column four wide">Pages number : <span id="pagesNumberText"></span></div>
      </div>
      <div class="tow column row">
        <div class="column tow wided"></div>
        <div class="fourteen wide column ui rail pdfPagesPrevieContainer">
          <div class="ui segment centered center aligned">
            <div>
              <div id="canvasContainer">
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div>
  <div class="actions">
    <div class="ui primary button positive">Submit</div>
  </div>
  <div class="corser" id="corser"><span id="textT"></span></div>
</div>

<script>
  // global vars to use in other scopes
  var pdfFile = null;
  var numPages;

  // page origin size
  var imgSize = 2480;
  var imgHeight = null;

  // init document key down, to detect if user pressd any 
  // nomric key
  var pressedKeyboardKey = null;
  var ctrlKey = false;
  // if only one signaturies it have to be just number one... 
  if (parseInt(numberOfSignaturies) === 1) {
    pressedKeyboardKey = 1;
  }

  // add keydown action for the document:
  $(document).keydown((e) => {
    // to ba sure that this action will never take
    // any other pressed key rether then nomric
    if (e.keyCode >= 97 && e.keyCode <= 105) {
      try {
        var parsedSingaturiesBumber = parseInt(numberOfSignaturies);
        if (parsedSingaturiesBumber === 1) {
          pressedKeyboardKey = 1;
        } else {
          // alarm the user that other then nomric Numbers are not allowed
          // in range 97 - 105
          if (e.keyCode >= 97 && e.keyCode <= 105) {
            pressedKeyboardKey = e.key;
            if (e.key > parseInt(numberOfSignaturies)) {
              alert("YOUR PEOPLE ARE ONLY : " + parseInt(numberOfSignaturies) + "SIGNATURIES.")
            }
          } else {
            alert("PLEASE PRESS ONLIC NUMBERS...")
          }
        }
      } catch (error) {
        alert("ENTERED SIGNATURIES NUMBER WRONG...");
      }

    } 
    // to check any other keyboard
    else {
      if (e.ctrlKey) {
        ctrlKey = true;
      }
    }

  });
  // add keyup action for the document
  $(document).keyup(() => {
    pressedKeyboardKey = null;
    ctrlKey = false;
  });

  /** to shpw the modal after  **/
  $(`#previewModal`).modal({
    closable: false,
    // set on modal show action
    onShow: (modal) => {
      console.log("Modal On Show")
      /** 
        First step is to  check eather the file PDF or IMG
        then i have to show the user the file with adding 
        action to choose which signaturies will be the next
         **/
      newFileToUpload; // uploaded file after changing the name
      newFileName; // entered file name
      numberOfSignaturies; // Signaturies number
      var fileType = newFileToUpload.type;
      var fileName = newFileToUpload.name;
      var fileSize = newFileToUpload.size;

      /** show data to user **/
      $(`#signsNumberText`).html(numberOfSignaturies);
      $(`#fileNameText`).html(fileName);
      $(`#fileTypeText`).html(fileType);


      /** check if the file is pdf **/
      if (fileType.split("/")[1].toLowerCase() === "pdf") {
        //  get file URL Blob for PDFJS
        var fileURL = URL.createObjectURL(newFileToUpload);

        // emiting to server 
        socket.emit("orderToConverTheFile", {
          fileName: fileName,
          fileSize: fileSize,
          fileType: fileType,
          newFileName: newFileName
        });

        // start handling pdf file
        PDFJS.getDocument(fileURL).then((doc) => {
          readPDFfileFromUploadedFile(doc);



        });

      }

      // in case was the uploaded file image not pdf
      else {}
    },
    // on modal hidden
    onHidden: () => {
      $(`#previewModal`).remove();
    }

  }).modal("show");

  // handling pdf doc
  function readPDFfileFromUploadedFile(pdf, imMoreThenOne) {
    pdfFile = pdf; // the pdf global
    numPages = pdf.numPages // the pages length 
    var isMultible = numPages > 1 ? true : false;
    // set page number to user
    $(`#pagesNumberText`).html(numPages);
    // itarate the pages from object

    for (let index = 0; index < numPages; index++) {
      pdf.getPage(index + 1).then((page) => {
        // append to continer
        handelSinglePage(page, isMultible);
      });
    }

  }


  // handeling singe page
  function handelSinglePage(page, isMultible) {

    // set pdf page view port scale
    var viewport = page.getViewport(imgSize / page.getViewport(1).width);
    // create new canvas
    var x = document.createElement("CANVAS");

    x.width = imgSize;
    // set canvas height
    imgHeight = page.getViewport(imgSize / page.getViewport(1).width).height
    x.height = imgHeight;
    // add id attr to canvas
    x.setAttribute("id", `canvos_${page.pageNumber}`);


    // set canvos container width 
    //$(`#canvasContainer`).width(x.width);
    // append the canvos into canvasContainer element
    $(`#canvasContainer`).append(x);


    // get canvas context for pdfjs render
    var context = $(`#canvos_${page.pageNumber}`).get(0).getContext('2d');

    //var sr = $(`#canvos_${page.pageNumber}`).width() / page.getViewport(1).width;


    // set canvas sizes from view port of pdf page
    // start rendaring the page 
    // in this section is just to render singe page
    page.render({
      canvasContext: context,
      viewport: viewport
    }).then(() => {
      createImageElement(x, page)
    });


    /**
     * todo : 
     * 1- create image element
     * 2- assign the canvas to this image
     * 3- set image small size to be able to control
     *    and zoom and so on
     * **/
  }

  //  action after file rendering
  function createImageElement(x, page) {
    // add css attrs to canvas
    x.style.display = "none";
    // get data of that image
    var getCanvasURL = x.toDataURL('image/png');

    // create img tag
    var img = $(
      `<img id="img_canv_${page.pageNumber}" width="${x.width / 4}" height="${x.height / 4}" 
      class="page_img" pageNum="${page.pageNumber}" style="border:1px black solid" >`
    );

    img.attr("src", getCanvasURL);


    // on mouse hover over the image
    $(img).mousemove((event) => {
      // start mouseonmove aciton 
      imagemouseOverAction(event, img);
    })

    // asign mouseover  action to the image
    // on mouse on the image 
    $(img).mouseover((event) => {
      // resize the image to orginal size
      // $(img).css("width", imgSize)
      //  $(img).css("height", imgHeight);
    })
    // add click on img action 
    $(img).click((event) => {
      // check if user pressed any number
      if (pressedKeyboardKey !== null) {
        // record mouse potions on click
        ImgOnClickAction(event, img)
      }
    })
    // create single image continer to add the sign relativ to it
    var singlImgeContainer =
      $(`<div id="singleImgeContainer" img_num="${page.pageNumber}" ></div>`);
    singlImgeContainer.width(x.width / 4)
    singlImgeContainer.height(x.height / 4);
    singlImgeContainer.css({
      position: "relative"
    })

    singlImgeContainer.append(img);
    // append the image into the canvas container
    $(`#canvasContainer`).append(singlImgeContainer);

    // to add divider after every page
    //if (isMultible) {
    //$(`#canvasContainer`).append('<h4 class="ui horizontal divider">ANOTHER</h4>');
    //}
    $(x).remove();

  }

  // make cordinations global
  var cord = {};
  // image mouseover action

  function imagemouseOverAction(event, img) {
    var bouds = $(img).get(0).getBoundingClientRect()

    // store mouse postions
    var mouseClientX = event.pageX;
    var mouseClientY = event.pageY;
    // create circle 
    $(`#corser`).css({
      top: mouseClientY - $(img).offset().top + bouds.y,
      left: mouseClientX - $(img).offset().left + bouds.x
    })

    // get current mouse corser cordination 
    // relatice to single image
    var x = (event.pageX - $(img).offset().left) + $(window).scrollLeft();
    var y = (event.pageY - $(img).offset().top) + $(window).scrollTop();

    // set postion reviewer postion 
    $(`#textT`).text(
      "Y : " +
      (y.toFixed(1)) +
      "  X : " +
      (x.toFixed(1)) +
      " IMG : " + $(img).attr("id")
    )
    // insert mouse postion into an object
    // to call them again leter
    cord[$(img).attr("id")] = {
      x: x,
      y: y
    }

  }

  // on click on the img action
  // stor all entered data into object
  // to be called when i want to marge the
  // signature with the image

  function ImgOnClickAction(event, img) {
    var imgID = $(img).attr("id");
    if (cord[imgID] !== null || cord[imgID] !== undefined) {
      console.log("x :  ", cord[imgID].x.toFixed(0), " y : ", cord[imgID].y.toFixed(0), "IMG ID : ", imgID)


      var sign = $(`<div class="ui red circular label">${pressedKeyboardKey}</div>`);
      var removeIcon = $(`<a class="delete icon"></a>`);
      //add remove ation for every single sign place label
      sign.click(removeSignPlaceLabel);


      var getSignLabelHeight = 25 / 2;
      var getSignLabelWidth = 100 / 2;

      // asign style to the coming  signature place 
      sign.css({
        position: "absolute",
        top: (cord[imgID].y.toFixed(0) - getSignLabelHeight) + "px",
        left: (cord[imgID].x.toFixed(0) - getSignLabelWidth) + "px",
        color: "red",
        width: "100px",
        height: "25px"
      });

      
      console.log("height : ", getSignLabelHeight, "width : ", getSignLabelWidth)

      // add the sign place on the image
      var singleImageContainer = $(`div[img_num='${$(img).attr("pagenum")}']`);
      singleImageContainer.append(sign);
    }
  }

  // if user want to remove sign place label
  // here is the action that for
  function removeSignPlaceLabel(event) {
    if (ctrlKey) {
      $(this).remove();
    }
  }
</script>